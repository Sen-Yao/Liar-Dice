<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQN训练流程图</title>
    <style>
        body {
            font-family: "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        svg {
            width: 100%;
            height: auto;
        }
        .box {
            fill: white;
            stroke: #333;
            stroke-width: 2;
            rx: 8;
        }
        .box-header {
            fill: #4a90e2;
            stroke: #4a90e2;
            stroke-width: 2;
            rx: 8;
        }
        .box-important {
            fill: #fff3cd;
            stroke: #ffc107;
            stroke-width: 2;
            rx: 8;
        }
        .box-network {
            fill: #d4edda;
            stroke: #28a745;
            stroke-width: 2;
            rx: 8;
        }
        .dashed-box {
            fill: none;
            stroke: #999;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            rx: 8;
        }
        .arrow {
            stroke: #666;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        .arrow-dashed {
            stroke: #999;
            stroke-width: 1.5;
            fill: none;
            stroke-dasharray: 5,5;
        }
        .text-title {
            font-size: 18px;
            font-weight: bold;
            fill: #333;
        }
        .text-normal {
            font-size: 14px;
            fill: #333;
        }
        .text-small {
            font-size: 12px;
            fill: #666;
        }
        .text-white {
            fill: white;
            font-weight: bold;
            font-size: 16px;
        }
        .text-code {
            font-family: "Monaco", "Consolas", monospace;
            font-size: 11px;
            fill: #d63384;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DQN 训练流程图（完整版）</h1>

        <svg viewBox="0 0 1400 2100" xmlns="http://www.w3.org/2000/svg">
            <!-- 定义箭头 -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#666" />
                </marker>
            </defs>

            <!-- 标题：对手调度策略 -->
            <rect class="dashed-box" x="50" y="20" width="1300" height="160"/>
            <text class="text-title" x="70" y="50">对手调度策略 (3种模式)</text>

            <!-- Heuristic -->
            <rect class="box" x="80" y="70" width="380" height="90"/>
            <text class="text-normal" x="100" y="100" font-weight="bold">heuristic: 全部规则对手</text>
            <text class="text-small" x="100" y="125">(动态 challenge_threshold: 0.3 → 0.7 线性增长)</text>
            <text class="text-small" x="100" y="145">基于概率估计决策，无 epsilon 探索</text>

            <!-- Selfplay -->
            <rect class="box" x="490" y="70" width="380" height="90"/>
            <text class="text-normal" x="510" y="100" font-weight="bold">selfplay: 全部冻结DQN快照</text>
            <text class="text-small" x="510" y="125">(固定 epsilon=0.1 探索)</text>
            <text class="text-small" x="510" y="145">从冻结池随机选择对手</text>

            <!-- Mixed -->
            <rect class="box" x="900" y="70" width="420" height="90"/>
            <text class="text-normal" x="920" y="100" font-weight="bold">mixed: 动态混合</text>
            <text class="text-small" x="920" y="125">Episode 粒度: 50% heuristic, 50% selfplay</text>
            <text class="text-small" x="920" y="145">Round 粒度: selfplay时随机选择冻结池对手</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="180" x2="700" y2="220"/>

            <!-- Episode 循环 -->
            <rect class="box-header" x="50" y="220" width="1300" height="50"/>
            <text class="text-white" x="600" y="250">Episode 循环 (10000 轮)</text>

            <!-- 冻结池更新 -->
            <rect class="box-important" x="100" y="300" width="450" height="60"/>
            <text class="text-normal" x="120" y="325" font-weight="bold">每 10 episodes 更新冻结池:</text>
            <text class="text-small" x="120" y="350">冻结当前在线网络 → frozen_pool (最多保留 5 个)</text>

            <!-- Round 循环 -->
            <rect class="box-header" x="100" y="390" width="1200" height="50"/>
            <text class="text-white" x="550" y="420">Round 循环 (每 episode 10 轮)</text>

            <!-- 主训练流程大框 -->
            <rect class="dashed-box" x="120" y="460" width="1160" height="1850"/>
            <text class="text-title" x="140" y="490">Step 循环 (直到 round 结束)</text>

            <!-- 学习智能体 -->
            <rect class="box" x="160" y="520" width="220" height="120"/>
            <text class="text-normal" x="180" y="545" font-weight="bold">学习智能体</text>
            <text class="text-small" x="180" y="570">1. 观察状态 + 合法动作</text>
            <text class="text-small" x="180" y="592">2. ε-greedy 选择动作</text>
            <text class="text-small" x="180" y="614">3. env.step(action)</text>
            <text class="text-code" x="180" y="633">ε ← max(0.1, ε×0.995)</text>

            <!-- 箭头：学习智能体 → 对手 -->
            <line class="arrow" x1="380" y1="580" x2="450" y2="580"/>

            <!-- 对手 -->
            <rect class="box" x="450" y="520" width="260" height="120"/>
            <text class="text-normal" x="470" y="545" font-weight="bold">对手</text>
            <text class="text-small" x="470" y="570">1. 观察状态 + 合法动作</text>
            <text class="text-small" x="470" y="592">2. 选择动作:</text>
            <text class="text-small" x="485" y="611">· heuristic: 概率决策</text>
            <text class="text-small" x="485" y="630">· selfplay: ε-greedy (ε=0.1)</text>

            <!-- 箭头：对手 → 势能塑形 -->
            <line class="arrow" x1="710" y1="580" x2="780" y2="580"/>

            <!-- 势能塑形 -->
            <rect class="box-important" x="780" y="535" width="200" height="90"/>
            <text class="text-normal" x="800" y="560" font-weight="bold">势能塑形</text>
            <text class="text-small" x="800" y="585">(可选, β=0.2)</text>
            <text class="text-code" x="800" y="610">r' = r + β(γΦ(s')-Φ(s))</text>

            <!-- 箭头：势能塑形 → n-step -->
            <line class="arrow" x1="980" y1="580" x2="1050" y2="580"/>

            <!-- n-step return -->
            <rect class="box" x="1050" y="520" width="190" height="120"/>
            <text class="text-normal" x="1070" y="545" font-weight="bold">N-步回报</text>
            <text class="text-small" x="1070" y="570">(n=3)</text>
            <text class="text-small" x="1070" y="592">累积 n_step_buffer</text>
            <text class="text-small" x="1070" y="611">buffer 满或 round 结束:</text>
            <text class="text-code" x="1070" y="630">push → ReplayBuffer</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="640" x2="700" y2="680"/>

            <!-- 触发条件 -->
            <rect class="box-important" x="350" y="680" width="700" height="70"/>
            <text class="text-normal" x="550" y="710" font-weight="bold">批量更新触发条件:</text>
            <text class="text-code" x="370" y="735">total_steps >= 100 (batch_update_start_steps) AND len(replay_buffer) >= 64 (batch_size)</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="750" x2="700" y2="790"/>

            <!-- Updates per step 循环 -->
            <rect class="dashed-box" x="160" y="790" width="1080" height="1450"/>
            <text class="text-title" x="180" y="820">循环 updates_per_step 次 (默认 1 次)</text>

            <!-- 采样 -->
            <rect class="box" x="200" y="850" width="180" height="80"/>
            <text class="text-normal" x="220" y="880" font-weight="bold">采样</text>
            <text class="text-small" x="220" y="905">从 ReplayBuffer 采样</text>
            <text class="text-code" x="220" y="922">batch_size = 64</text>

            <!-- 箭头 -->
            <line class="arrow" x1="380" y1="890" x2="450" y2="890"/>

            <!-- 解码动作 -->
            <rect class="box" x="450" y="850" width="220" height="80"/>
            <text class="text-normal" x="470" y="880" font-weight="bold">解码动作元组</text>
            <text class="text-code" x="470" y="905">(action_type, mode,</text>
            <text class="text-code" x="470" y="922"> count, face) → 索引</text>

            <!-- 箭头 -->
            <line class="arrow" x1="670" y1="890" x2="740" y2="890"/>

            <!-- 在线网络前向传播 -->
            <rect class="box-network" x="740" y="835" width="240" height="110"/>
            <text class="text-normal" x="760" y="865" font-weight="bold">在线网络前向传播</text>
            <text class="text-small" x="760" y="890">计算当前 Q 值</text>
            <text class="text-code" x="760" y="910">main_q, mode_q,</text>
            <text class="text-code" x="760" y="927">count_q, face_q</text>
            <text class="text-code" x="760" y="940">= q_network(states)</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="950" x2="700" y2="1000"/>

            <!-- 计算目标 Q 值大框 -->
            <rect class="dashed-box" x="200" y="1000" width="1000" height="350"/>
            <text class="text-title" x="220" y="1030">计算目标 Q 值</text>

            <!-- DDQN 分支 -->
            <rect class="box-network" x="240" y="1060" width="440" height="260"/>
            <text class="text-normal" x="260" y="1090" font-weight="bold">DDQN 模式:</text>

            <text class="text-small" x="260" y="1120">步骤1: 在线网络选择动作</text>
            <rect class="box" x="280" y="1135" width="380" height="55"/>
            <text class="text-code" x="300" y="1157">next_q = q_network(next_states)</text>
            <text class="text-code" x="300" y="1175">a* = argmax(legal_masked_next_q)</text>

            <text class="text-small" x="260" y="1215">步骤2: 目标网络评估该动作</text>
            <rect class="box" x="280" y="1230" width="380" height="70"/>
            <text class="text-code" x="300" y="1252">target_q = target_network(</text>
            <text class="text-code" x="330" y="1270">next_states)</text>
            <text class="text-code" x="300" y="1288">Q_next = target_q[a*]</text>

            <!-- DQN 分支 -->
            <rect class="box-network" x="720" y="1060" width="440" height="260"/>
            <text class="text-normal" x="740" y="1090" font-weight="bold">传统 DQN 模式:</text>

            <text class="text-small" x="740" y="1120">目标网络直接选择并评估</text>
            <rect class="box" x="760" y="1135" width="380" height="70"/>
            <text class="text-code" x="780" y="1157">target_q = target_network(</text>
            <text class="text-code" x="810" y="1175">next_states)</text>
            <text class="text-code" x="780" y="1193">Q_next = max(legal_masked_q)</text>

            <text class="text-small" x="740" y="1235">问题: 同一网络选择+评估</text>
            <text class="text-small" x="740" y="1255">→ Q 值过高估计</text>

            <!-- 合并箭头（简化版） -->
            <line class="arrow" x1="460" y1="1320" x2="460" y2="1390"/>
            <line class="arrow" x1="940" y1="1320" x2="940" y2="1390"/>
            <line class="arrow" x1="460" y1="1390" x2="700" y2="1390"/>
            <line class="arrow" x1="940" y1="1390" x2="700" y2="1390"/>
            <line class="arrow" x1="700" y1="1390" x2="700" y2="1420"/>

            <!-- 计算 TD 目标 -->
            <rect class="box-important" x="450" y="1420" width="500" height="70"/>
            <text class="text-normal" x="560" y="1450" font-weight="bold">计算 TD 目标</text>
            <text class="text-code" x="470" y="1475">y = reward + n_step_discount × Q_next × (1 - done)</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="1490" x2="700" y2="1540"/>

            <!-- 计算损失 -->
            <rect class="box" x="550" y="1540" width="300" height="70"/>
            <text class="text-normal" x="620" y="1570" font-weight="bold">计算损失</text>
            <text class="text-code" x="570" y="1595">Loss = SmoothL1(Q_current, y)</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="1610" x2="700" y2="1660"/>

            <!-- 反向传播 -->
            <rect class="box" x="520" y="1660" width="360" height="100"/>
            <text class="text-normal" x="630" y="1690" font-weight="bold">反向传播</text>
            <text class="text-code" x="540" y="1715">optimizer.zero_grad()</text>
            <text class="text-code" x="540" y="1735">loss.backward()</text>
            <text class="text-code" x="540" y="1752">clip_grad_norm_(max_norm=1.0)</text>

            <!-- 向下箭头 -->
            <line class="arrow" x1="700" y1="1760" x2="700" y2="1810"/>

            <!-- Polyak 软更新 -->
            <rect class="box-network" x="420" y="1810" width="560" height="110"/>
            <text class="text-normal" x="550" y="1840" font-weight="bold">Polyak 软更新目标网络</text>
            <text class="text-small" x="440" y="1865">(每次批量更新都执行)</text>
            <text class="text-code" x="440" y="1888">θ_target ← τ × θ_online + (1-τ) × θ_target</text>
            <text class="text-code" x="600" y="1908">(τ = 0.005)</text>

            <!-- 循环回箭头 -->
            <line class="arrow-dashed" x1="200" y1="1150" x2="140" y2="1150"/>
            <line class="arrow-dashed" x1="140" y1="1150" x2="140" y2="700"/>
            <line class="arrow-dashed" x1="140" y1="700" x2="350" y2="700"/>
            <text class="text-small" x="30" y="930" fill="#999">循环</text>

            <!-- 底部：快速评估和保存 -->
            <rect class="box-important" x="200" y="2000" width="450" height="80"/>
            <text class="text-normal" x="220" y="2030" font-weight="bold">快速评估 (可选, 默认关闭)</text>
            <text class="text-small" x="220" y="2055">对战启发式对手, 计算胜率</text>
            <text class="text-code" x="220" y="2073">--quick_eval 启用</text>

            <rect class="box" x="700" y="2000" width="450" height="80"/>
            <text class="text-normal" x="720" y="2030" font-weight="bold">模型保存</text>
            <text class="text-small" x="720" y="2055">每 500 episodes: 保存检查点</text>
            <text class="text-small" x="720" y="2073">训练结束: 保存最终模型 + config.json</text>

        </svg>
    </div>
</body>
</html>